# Async Banking API Service

Асинхронное REST API для работы с пользователями, администраторами, счетами и платежами.  
Реализовано на **FastAPI**, **SQLAlchemy (async)** и **PostgreSQL**, полностью контейнеризовано с помощью Docker и docker-compose.

---

## Оглавление

- [Описание проекта](#описание-проекта)
- [Модели данных](#модели-данных)
- [API](#api)
  - [Пользователь](#пользователь)
  - [Счета](#cчета)
  - [Платежи](#платежи)
- [Валидация и ограничения](#валидация-и-ограничения)
- [Запуск проекта](#запуск-проекта)
- [Миграции базы данных](#миграции-базы-данных)
- [Тестирование](#тестирование)
- [Линтеры и форматирование кода](#линтеры-и-форматирование-кода)
- [Docker и docker-compose](#docker-и-docker-compose)

---

## Описание проекта

Проект предоставляет REST API для управления:

- Пользователями и администраторами
- Счетами и балансами пользователей
- Платежами (пополнением баланса через эмуляцию вебхука)

Основные возможности:

- **Пользователь**:
  - Авторизация по email/password
  - Получение данных о себе (id, email, full_name)
  - Получение списка своих счетов и балансов
  - Получение списка своих платежей

- **Администратор**:
  - Авторизация по email/password
  - Получение данных о себе (id, email, full_name)
  - Создание/удаление/обновление пользователей
  - Получение списка пользователей и их счетов с балансами

- **Платежи**:
  - Эмуляция вебхука сторонней платежной системы
  - Проверка подписи транзакции (SHA256 с секретным ключом)
  - Создание счета при отсутствии
  - Сохранение уникальных транзакций
  - Начисление суммы на счет пользователя

Стек технологий: **FastAPI**, **SQLAlchemy (async)**, **PostgreSQL**, **Docker**, **Docker Compose**.

---

## Модели данных

### User / Администратор

| Поле      | Тип   | Описание                  |
|-----------|------|---------------------------|
| id        | int  | Уникальный идентификатор  |
| email     | str  | Email                     |
| full_name | str  | Полное имя                |
| password  | str  | Хеш пароля                |
| role      | str  | Роль: USER / ADMIN        |
| created_at | datetime | Время создания записи |
| updated_at | datetime | Время обновления записи |


### Account / Счет

| Поле      | Тип   | Описание                  |
|-----------|------|---------------------------|
| id        | int  | Уникальный идентификатор  |
| user_id   | int  | ID пользователя (FK)      |
| balance   | float| Баланс счета              |
| created_at | datetime | Время создания записи |
| updated_at | datetime | Время обновления записи |

### Payment / Платеж

| Поле           | Тип    | Описание                                |
|----------------|-------|----------------------------------------|
| id             | int   | Уникальный идентификатор в базе        |
| transaction_id | str   | Уникальный идентификатор транзакции     |
| account_id     | int   | ID счета пользователя                  |
| user_id        | int   | ID пользователя                        |
| amount         | float | Сумма пополнения                        |
| signature      | str   | Подпись объекта      |
| created_at | datetime | Время создания записи |
| updated_at | datetime | Время обновления записи |

---

## API

### Пользователь

- **GET /user/me** — получить данные о текущем пользователе  
- **POST /user/create** — создание пользователя  
- **POST /user/update/{user_id}** — обновление пользователя
- **POST /user/delete/{user_id}** — удаление пользователя
- **GET /user/list** — получение списка пользователей и их балансов
- **GET /user/{user_id}** — получить информациюо пользователе и его балансе  

Проверка прав пользователя и получение информации о нем осуществялется с помощью middleware при каждом запросе.

### Счета

- **GET /accounts/me** — получить данные о своих счетах 

### Платежи

- **POST /payments/me** — получить свои платежные операции
- **GET /payments/webhook** — обработка вебхука платежной системы  


Пример JSON вебхука:

```json
{
  "transaction_id": "5eae174f-7cd0-472c-bd36-35660f00132b",
  "user_id": 1,
  "account_id": 1,
  "amount": 100,
  "signature": "7b47e41efe564a062029da3367bde8844bea0fb049f894687cee5d57f2858bc8"
}
```

Проверка:

- Подпись формируется через SHA256 из строки ```{account_id}{amount}{transaction_id}{user_id}{secret_key}```
- Если счета нет — создается новый
- Транзакция сохраняется и сумма зачисляется на счет пользователя
- Начисление происходит только один раз для каждого transaction_id

---

## Валидация и ограничения

- Уникальность transaction_id и email пользователей

- Проверка подписи платежа

- Сумма платежа > 0

- Пользователь не может видеть чужие счета и платежи

- Администратор имеет доступ ко всем пользователям и счетам

---

## Запуск проекта

1. Клонирование репозитория
```bash
git clone <repo-url>
cd dimatech
```

2. Установка зависимостей (Poetry)
```bash
poetry install
```

3. Создание файла окружения
```bash
cp .env.example .env
```

4. Запуск через Docker Compose
```bash
docker compose up -d --build
```

или через Makefile

```bash
make up_compose_local
```

API будет доступно по адресу: ```http://localhost:8000```

5. Запуск без Docker

- Установить PostgreSQL локально

- Настроить ```.env``` с параметрами базы данных

- Запустить приложение через Poetry:
```bash
poetry run uvicorn app.main:app --reload
```

---

## Миграции базы данных

- Миграции хранятся в ```alembic/versions```

- Генерация миграции:
```bash
alembic revision --autogenerate -m "описание миграции"
```

Применение миграции:
```bash
alembic upgrade head
```

В миграциях создаются тестовый пользователь, счет и администратор:

- **User**: ```user@example.com / password123```

- **Admin**: ```admin@example.com / admin123```

---

## Тестирование

Для проверки и создания тестовых данных для эмулирования вебхука есть скрипт, он расположен ```/app/scripts/gen_webhook_payload.py```. Генерируем данные и вставляем в запрос для вебхука.

---

## Линтеры и форматирование кода

- **black** — автоформатирование

- **isort** — сортировка импортов

- **ruff** — статический анализ

Примеры команд Makefile:
```bash
make run_linters     # Проверка кода
make run_formaters   # Применение black и isort
```
---

## Docker и docker-compose

- **PostgreSQL 15**

- **FastAPI** с hot reload

- Контейнеры:

    - ```db``` — база данных

    - ```api``` — приложение FastAPI

- Подключение к базе:
```bash
docker compose exec api psql -U postgres -d dimatech_db
```

- Поднять контейнеры
```bash
docker compose up -d --build
```

или

```bash
make up_compose_local
```

- Положить контейнеры
```bash
docker compose down -v
```

или

```bash
make down_compose_local
```
---
